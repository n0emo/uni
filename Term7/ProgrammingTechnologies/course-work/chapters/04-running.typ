= 4. Конфигурация и запуск

== 4.1 Структура конфигурационного файла

Конфигурация сервера описывается в формате TOML с использованием библиотеки
config-rs. Базовые параметры включают адрес и порт прослушивания (по умолчанию
127.0.0.1:9150) и директорию плагинов (plugins). Секция plugins содержит
вложенные таблицы для каждого плагина с произвольным набором настроек.

Загрузка конфигурации выполняется через Config::builder с установкой значений по
умолчанию и попыткой чтения файла config.toml из текущей директории. Отсутствие
файла не является ошибкой, в этом случае используются дефолтные значения.
Десериализация происходит в структуру Config с обработкой ошибок парсинга через
логирование.

Нормализация base_url включает удаление завершающего слеша для обеспечения
консистентности путей. Плагины без явно заданного base_url получают пустую
строку, что эквивалентно монтированию в корень. Такое поведение позволяет
плагину обслуживать запросы без префикса пути.

== 4.2 Инициализация Wasmtime-движка

Создание Wasmtime Engine требует конфигурации с включённой асинхронной
поддержкой через wasmtime::Config::async_support. Это необходимо для интеграции
с асинхронной средой выполнения Tokio, на которой построен весь сервер. Движок
создаётся один раз при старте и используется для инстанцирования всех плагинов.

Linker настраивается с добавлением хост-функций для всех используемых
WASI-интерфейсов. Вызовы wasmtime_wasi::p2::add_to_linker_async и
wasmtime_wasi_http::add_only_http_to_linker_async регистрируют стандартные
WASI-реализации. Для wasi:config требуется явное указание функции доступа к
конфигурационным переменным через замыкание.

Предварительная инстанциация через InstancePre выполняется для каждого
загруженного компонента и сохраняется в образе плагина. При обработке запроса
вызов instantiate_async создаёт новый экземпляр из предкомпилированного шаблона
за время порядка микросекунд. Это критично для производительности при высокой
нагрузке.

== 4.3 Обработка ошибок и логирование

Система логирования построена на библиотеке tracing с фильтрацией по уровням
через переменную окружения RUST_LOG. По умолчанию выводятся сообщения уровня
INFO и выше, с подавлением отладочных сообщений от Wasmtime и Cranelift.
Форматирование настроено без вывода целевого модуля для сокращения шума в логах.

Ошибки загрузки плагинов логируются с указанием пути к директории и описанием
проблемы, но не останавливают запуск сервера. Счётчики успешно загруженных и
проблемных плагинов выводятся в итоговом сообщении. Такое поведение позволяет
серверу функционировать даже при наличии повреждённых плагинов.

Ошибки выполнения плагинов обрабатываются через тип PluginHandleError с
вариантами для различных сценариев: отсутствие эндпоинта, ошибки получения
экспорта, создания ресурсов, вызова метода. Каждая ошибка логируется на уровне
DEBUG и преобразуется в HTTP 500 для клиента. Детали ошибки не раскрываются в
ответе из соображений безопасности.
